L.interpolatePosition=function(t,i,a,e){var r=e/a;return r=r>0?r:0,r=r>1?1:r,L.latLng(t.lat+r*(i.lat-t.lat),t.lng+r*(i.lng-t.lng))};L.Marker.MovingMarker=L.Marker.extend({statics:{notStartedState:0,endedState:1,pausedState:2,runState:3},options:{autostart:!1,loop:!1},initialize:function(t,i,a){L.Marker.prototype.initialize.call(this,t[0],a),this._latlngs=t.map(function(e,r){return L.latLng(e)}),i instanceof Array?this._durations=i:this._durations=this._createDurations(this._latlngs,i),this._currentDuration=0,this._currentIndex=0,this._state=L.Marker.MovingMarker.notStartedState,this._startTime=0,this._startTimeStamp=0,this._pauseStartTime=0,this._animId=0,this._animRequested=!1,this._currentLine=[],this._stations={}},isRunning:function(){return this._state===L.Marker.MovingMarker.runState},isEnded:function(){return this._state===L.Marker.MovingMarker.endedState},isStarted:function(){return this._state!==L.Marker.MovingMarker.notStartedState},isPaused:function(){return this._state===L.Marker.MovingMarker.pausedState},start:function(){this.isRunning()||(this.isPaused()?this.resume():(this._loadLine(0),this._startAnimation(),this.fire("start")))},resume:function(){this.isPaused()&&(this._currentLine[0]=this.getLatLng(),this._currentDuration-=this._pauseStartTime-this._startTime,this._startAnimation())},pause:function(){this.isRunning()&&(this._pauseStartTime=Date.now(),this._state=L.Marker.MovingMarker.pausedState,this._stopAnimation(),this._updatePosition())},stop:function(t){this.isEnded()||(this._stopAnimation(),typeof t>"u"&&(t=0,this._updatePosition()),this._state=L.Marker.MovingMarker.endedState,this.fire("end",{elapsedTime:t}))},addLatLng:function(t,i){this._latlngs.push(L.latLng(t)),this._durations.push(i)},moveTo:function(t,i){this._stopAnimation(),this._latlngs=[this.getLatLng(),L.latLng(t)],this._durations=[i],this._state=L.Marker.MovingMarker.notStartedState,this.start(),this.options.loop=!1},addStation:function(t,i){t>this._latlngs.length-2||t<1||(this._stations[t]=i)},onAdd:function(t){if(L.Marker.prototype.onAdd.call(this,t),this.options.autostart&&!this.isStarted()){this.start();return}this.isRunning()&&this._resumeAnimation()},onRemove:function(t){L.Marker.prototype.onRemove.call(this,t),this._stopAnimation()},_createDurations:function(t,i){for(var a=t.length-1,e=[],r=0,c=0,n=0;n<a;n++)c=t[n+1].distanceTo(t[n]),e.push(c),r+=c;var b=i/r,p=[];for(n=0;n<e.length;n++)p.push(e[n]*b);return p},_startAnimation:function(){this._state=L.Marker.MovingMarker.runState,this._animId=L.Util.requestAnimFrame(function(t){this._startTime=Date.now(),this._startTimeStamp=t,this._animate(t)},this,!0),this._animRequested=!0},_resumeAnimation:function(){this._animRequested||(this._animRequested=!0,this._animId=L.Util.requestAnimFrame(function(t){this._animate(t)},this,!0))},_stopAnimation:function(){this._animRequested&&(L.Util.cancelAnimFrame(this._animId),this._animRequested=!1)},_updatePosition:function(){var t=Date.now()-this._startTime;this._animate(this._startTimeStamp+t,!0)},_loadLine:function(t){this._currentIndex=t,this._currentDuration=this._durations[t],this._currentLine=this._latlngs.slice(t,t+2)},_updateLine:function(t){var i=t-this._startTimeStamp;if(i<=this._currentDuration)return i;for(var a=this._currentIndex,e=this._currentDuration,r;i>e;){if(i-=e,r=this._stations[a+1],r!==void 0){if(i<r)return this.setLatLng(this._latlngs[a+1]),null;i-=r}if(a++,a>=this._latlngs.length-1)if(this.options.loop)a=0,this.fire("loop",{elapsedTime:i});else return this.setLatLng(this._latlngs[this._latlngs.length-1]),this.stop(i),null;e=this._durations[a]}return this._loadLine(a),this._startTimeStamp=t-i,this._startTime=Date.now()-i,i},_animate:function(t,i){this._animRequested=!1;var a=this._updateLine(t);if(!this.isEnded()){if(a!=null){var e=L.interpolatePosition(this._currentLine[0],this._currentLine[1],this._currentDuration,a);this.setLatLng(e)}i||(this._animId=L.Util.requestAnimFrame(this._animate,this,!1),this._animRequested=!0)}}});L.Marker.movingMarker=function(t,i,a){return new L.Marker.MovingMarker(t,i,a)};const S=window.burl,T="/assets/images/leaflet/marker-reddot.png";var g=$("#tbllogsdet").DataTable({dom:"Bfrtip",buttons:[{extend:"copy"},{extend:"pdf"},{extend:"print"},{extend:"excel"}],scrollX:!0,order:[[0,"asc"]],columnDefs:[{target:0,visible:!1,searchable:!1}]});$("#tbllogsdet").width("100%");var v,k,M,s=L.map("trackingmap",{minZoom:5,fullscreenControl:!0,attributionControl:!1}).setView([.33995192349439596,120.3733680354565],5),h={},m=new L.FeatureGroup,l=[],f,d=[],u=[],o=null,y=L.tileLayer(window.mapLayer);y.addTo(s);function w(t,i=null,a=null,e=null){var r;if(i?r=L.marker(t,i):r=L.marker(t),e){var c=L.popup().setContent(e);r.bindPopup(c).openPopup()}if(a){var n=L.tooltip().setContent(a);r.bindTooltip(n).openTooltip()}return r.addTo(s),r}function x(t){f=new L.Polyline(t,{color:"red",weight:5,opacity:.5,smoothFactor:1}),f.addTo(s)}$("#formMapTrack").submit(function(t){t.preventDefault(),v=$("input[name=device_id]").val(),k=$("input[name=txtdtfrom]").val(),M=$("input[name=txtdtto]").val();for(const[i,a]of Object.entries(h))s.removeLayer(h[i]),delete h[i];l.forEach(function(i){delete l[i]}),d.forEach(function(i){delete d[i]}),u.forEach(function(i){delete u[i]}),f&&s.removeLayer(f),o&&(s.removeLayer(o),o=null),l=null,u=null,d=null,d=[],u=[],l=[],g.clear().draw(),$.get(S+"/tracking/detail/js/map?did="+v+"&from="+k+"&to="+M,function(i){$.each(i.relay.data,function(a,e){h[e.id]=w({lat:e.fflat,lng:e.fflon},{icon:L.icon({iconUrl:T,iconSize:[10,20],iconAnchor:[6,15],popupAnchor:[0,-15]})},e.created_at,A(e)),m.addLayer(h[e.id]),m.addTo(s),l.push({lat:e.fflat,lng:e.fflon}),d.push([e.fflat,e.fflon]),u.push(500),e.alt&&parseFloat(parseFloat(e.alt)/3.2808).toFixed(2),g.row.add([e.id,e.created_at,e.fflat,e.fflon,e.ffaccuracy_cep,e.ffdirection,e.ffspeed,e.ffaltitude]).draw(!0)}),i.relay.data.length!=0?(s.fitBounds(m.getBounds()),x(l),o=new L.Marker.movingMarker(d,u).addTo(s),o.start(),o.on("end",function(){o.start()})):console.log("No Data")})});$(".datepicker").datetimepicker({format:"YYYY-MM-DD HH:mm:ss"});function _(t,i,a){return t>=i&&t<=a}var A=function(t){var i="n/a";return _(parseInt(t.fnsignal),0,10)?i="Poor":_(parseInt(t.fnsignal),11,20)?i="Good":_(parseInt(t.fnsignal),21,31)&&(i="Excelent"),'<h3 class="h6 text-center d-block text-uppercase font-weight-bold">INFO</h3><span class="bottom-line d-block mx-auto mt-3 mb-4"></span><div class="row my-2 mx-auto"><div class="col text-right border-right border-dark">DATE TIME</div><div class="col-7 pl-4">'+t.created_at+'</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">ALT (Meters)</div><div class="col-7 pl-4">'+parseFloat(parseFloat(t.ffaltitude)/3.2808).toFixed(2)+'</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">SPEED</div><div class="col-7 pl-4">'+t.ffspeed+'Km/h</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">ACCURACY (CEP)</div><div class="col-7 pl-4">'+t.ffaccuracy_cep+'</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">SIGNAL</div><div class="col-7 pl-4">'+t.fnsignal+" ("+i+')</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">DIRECTION</div><div class="col-7 pl-4">'+t.ffdirection+'</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">COORDINATE</div><div class="col-7 pl-4">'+t.fflat.toString()+", "+t.fflon.toString()+'</div></div><div class="row my-2 mx-auto"><div class="col-5 text-right border-right border-dark">SATTELITE</div><div class="col-7 pl-4">'+t.fnsattelite+"</div></div>"};
