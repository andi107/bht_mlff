const c=location.protocol+"//"+window.location.host;var t=[],d="https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",g=L.tileLayer(d,{minZoom:5}),l=new L.Map("objmap",{center:new L.LatLng(.339951,120.373368),zoom:5,attributionControl:!1,fullscreenControl:!0}),a=L.featureGroup().addTo(l),r={};L.Control.geocoder().addTo(l);L.control.layers({osm:g.addTo(l),google:L.tileLayer("http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}",{attribution:"google"})},{drawlayer:a},{position:"topright",collapsed:!1}).addTo(l);self.resPolygon={};self.drawControlFull=new L.Control.Draw({edit:{featureGroup:a,poly:{allowIntersection:!1}},draw:{polygon:{allowIntersection:!1,showArea:!0},polyline:!1,rectangle:!1,marker:!1,circle:!1,circlemarker:!1}});self.drawControlEdit=new L.Control.Draw({edit:{featureGroup:a,poly:{allowIntersection:!1}},draw:!1});l.addControl(drawControlFull);l.on(L.Draw.Event.CREATED,function(n){if(self.Polygon||self.Circle)return alert("You can only create 1 location per geofence"),null;var e=n.layer;if(console.log(e),e._latlng&&e._mRadius)console.log("circle"),window.circle=e,a.addLayer(e);else if(e._latlngs&&e._bounds){if(t=e._latlngs[0],t.length<4)return alert("Minimum 4 points required!"),null;self.Polygon=e,self.Polygon.setStyle({color:"#D61355",fillColor:"#D61355",fillOpacity:.1})}else return swal("Please make 1 Geofencing!","","Warning"),null;self.drawControlFull.remove(),self.drawControlEdit.addTo(l),a.addLayer(e),console.log("Final",self.Polygon,self.Circle)});l.on(L.Draw.Event.EDITED,function(n){var e=n.layers;e.eachLayer(function(o){if(console.log("edited",o),o._latlng&&o._mRadius)console.log("circle");else if(o._latlngs&&o._bounds){if(console.log("polygon"),t=o._latlngs[0],t.length<4)return toastr.error("Minimum 4 points required!","Warning"),self.Polygon.remove(),self.Polygon=null,self.drawControlEdit.remove(),self.drawControlFull.addTo(l),a.clearLayers(),null;console.log("PolyF",self.Polygon)}else toastr.error("Please make 1 Geofencing!","Error")})});l.on(L.Draw.Event.DELETED,function(n){var e=n.layers;e.eachLayer(function(o){console.log("deleted",o),self.Circle=null,self.Polygon=null,t=[],self.drawControlEdit.remove(),self.drawControlFull.addTo(l)})});$("#formGeo").submit(function(n){console.log($("input[name=_id]").val()),n.preventDefault();var e=new FormData;if(e.append("_token",$("input[name=_token]").val()),e.append("id",$("input[name=_id]").val()),e.append("txtName",$("input[name=txtName]").val()),e.append("txtAddress",$("textarea[name=txtAddress]").val()),typeof self.Polygon<"u"&&self.Polygon!==null){for(const[o,s]of Object.entries(r))delete r[o];$.each(self.Polygon._latlngs,function(o,s){$.each(s,function(f,i){r[f]={lat:i.lat,lng:i.lng}})}),console.log(JSON.stringify(r)),e.append("geo_type",1),e.append("polygon_point",JSON.stringify(r))}else return toastr.error("Please make 1 Geofencing!","Warning"),null;$.ajax({type:"POST",url:c+"/geo/js/add",data:e,dataType:"json",contentType:!1,cache:!1,processData:!1,beforeSend:function(){$("#formGeo").css("opacity",".5")},success:function(o){$("#formGeo").css("opacity",""),console.log(o)}})});
